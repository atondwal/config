#!/bin/bash
set -xeu
# Get active window position, find which monitor it's on, calculate that monitor's DPI
WIN_POS=$(xdotool getactivewindow getwindowgeometry 2>/dev/null | awk '/Position:/ {print $2}')
WIN_X=${WIN_POS%,*}
WIN_Y=${WIN_POS#*,}
DPI=$(xrandr --query 2>/dev/null | awk -v wx="${WIN_X:-0}" -v wy="${WIN_Y:-0}" '
    / connected.*[0-9]+x[0-9]+\+/ {
        match($0, /([0-9]+)x([0-9]+)\+([0-9]+)\+([0-9]+)/, geo)
        match($0, /([0-9]+)mm x ([0-9]+)mm/, mm)
        if (mm[1] > 0 && wx >= geo[3] && wx < geo[3] + geo[1] && wy >= geo[4] && wy < geo[4] + geo[2]) {
            printf "%.0f\n", geo[1] / (mm[1] / 25.4); exit
        }
    }')

# Set font size based on DPI threshold (default to 16 if detection fails)
if [ -z "$DPI" ] || ! [ "$DPI" -gt 0 ] 2>/dev/null; then
    FONTSIZE=16
elif [ "$DPI" -gt 225 ]; then
    FONTSIZE=64  # e-ink
elif [ "$DPI" -gt 150 ]; then
    FONTSIZE=22  # Mid-DPI (eDP-1 laptop ~158 DPI)
else
    FONTSIZE=16  # Standard DPI (external monitors)
fi

exec /usr/bin/mlterm --fontsize="$FONTSIZE" "$@"
