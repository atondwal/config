#!/bin/bash

ROUTER_URL="http://192.168.1.254/cgi-bin/devices.ha"

if [ $# -eq 0 ]; then
    echo "Usage: lssh <device-name> [ssh-options]"
    echo "Lists devices: lssh --list"
    exit 1
fi

# List all devices
if [ "$1" == "--list" ] || [ "$1" == "-l" ]; then
    echo "Fetching devices from router..."
    echo
    printf "%-25s %-18s %-16s %s\n" "NAME" "MAC ADDRESS" "IP ADDRESS" "STATUS"
    printf "%-25s %-18s %-16s %s\n" "-------------------------" "------------------" "----------------" "------"
    
    curl -s "$ROUTER_URL" | python3 -c "
import sys
import re

html = sys.stdin.read()
lines = html.split('\\n')

devices = []
i = 0

while i < len(lines):
    line = lines[i]
    
    if 'MAC Address</th>' in line and i+1 < len(lines):
        device = {'mac': '', 'name': '', 'ip': '', 'status': ''}
        
        # Get MAC
        i += 1
        mac_match = re.search(r'([0-9a-f:]{17})', lines[i])
        if mac_match:
            device['mac'] = mac_match.group(1)
        
        # Continue through device fields
        j = i + 1
        while j < len(lines) and '<hr class=\"reshr\"' not in lines[j]:
            if 'Name</th>' in lines[j] and 'IPv4' not in lines[j] and j+1 < len(lines):
                name_match = re.search(r'>([^<]+)<', lines[j+1])
                if name_match:
                    device['name'] = name_match.group(1).strip()
            
            elif 'IPv4 Address / Name' in lines[j]:
                content = ''
                for k in range(j+1, min(j+5, len(lines))):
                    content += lines[k]
                
                ip_match = re.search(r'(\\d+\\.\\d+\\.\\d+\\.\\d+)', content)
                if ip_match:
                    device['ip'] = ip_match.group(1)
                
                name_match = re.search(r'/\\s*([^<\\n]+)', content)
                if name_match:
                    alt_name = name_match.group(1).strip()
                    if not device['name'] or device['name'].startswith('unknown'):
                        device['name'] = alt_name
            
            elif 'Status</th>' in lines[j] and j+1 < len(lines):
                status_match = re.search(r'>([^<]+)<', lines[j+1])
                if status_match:
                    device['status'] = status_match.group(1).strip()
            
            j += 1
        
        if device['mac']:
            devices.append(device)
        i = j
    else:
        i += 1

# Print devices
for dev in devices:
    name = dev['name'] or 'unknown'
    ip = dev['ip'] or '-'
    status = dev['status'] or '-'
    print(f\"{name[:25]:<25} {dev['mac']:<18} {ip:<16} {status}\")
" 2>/dev/null || echo "Error parsing device list"
    
    exit 0
fi

DEVICE_NAME="$1"
shift  # Remove device name from arguments, keep SSH options

echo "Looking up device: $DEVICE_NAME"

# Get device info using Python for more reliable parsing
DEVICE_INFO=$(curl -s "$ROUTER_URL" | python3 -c "
import sys
import re

target = '$DEVICE_NAME'.lower()
html = sys.stdin.read()

# Parse devices
devices = []
lines = html.split('\\n')
i = 0

while i < len(lines):
    line = lines[i]
    
    if 'MAC Address</th>' in line and i+1 < len(lines):
        # Start new device
        device = {'mac': '', 'name': '', 'ip': '', 'status': ''}
        
        # Get MAC
        i += 1
        mac_match = re.search(r'([0-9a-f:]{17})', lines[i])
        if mac_match:
            device['mac'] = mac_match.group(1)
        
        # Continue through device fields
        j = i + 1
        while j < len(lines) and '<hr class=\"reshr\"' not in lines[j]:
            if 'Name</th>' in lines[j] and 'IPv4' not in lines[j] and j+1 < len(lines):
                name_match = re.search(r'>([^<]+)<', lines[j+1])
                if name_match:
                    device['name'] = name_match.group(1).strip()
            
            elif 'IPv4 Address / Name' in lines[j]:
                # Check next few lines for IP and name
                content = ''
                for k in range(j+1, min(j+5, len(lines))):
                    content += lines[k]
                
                ip_match = re.search(r'(\\d+\\.\\d+\\.\\d+\\.\\d+)', content)
                if ip_match:
                    device['ip'] = ip_match.group(1)
                
                name_match = re.search(r'/\\s*([^<\\n]+)', content)
                if name_match:
                    alt_name = name_match.group(1).strip()
                    if not device['name'] or device['name'].startswith('unknown'):
                        device['name'] = alt_name
            
            elif 'Status</th>' in lines[j] and j+1 < len(lines):
                status_match = re.search(r'>([^<]+)<', lines[j+1])
                if status_match:
                    device['status'] = status_match.group(1).strip()
            
            j += 1
        
        # Check if this device matches
        if device['name'].lower() == target or (device['name'].lower().find(target) >= 0):
            print(f\"{device['mac']}|{device['name']}|{device['ip']}|{device['status']}\")
            sys.exit(0)
        
        i = j
    else:
        i += 1
" 2>/dev/null)

if [ -z "$DEVICE_INFO" ]; then
    echo "Error: Device '$DEVICE_NAME' not found in router table"
    echo "Try 'lssh --list' to see available devices"
    exit 1
fi

# Parse the device info
IFS='|' read -r MAC NAME IP STATUS <<< "$DEVICE_INFO"

if [ -z "$IP" ] || [ "$IP" == "" ]; then
    echo "Error: No IP address found for device '$NAME' (MAC: $MAC)"
    echo "Device status: $STATUS"
    exit 1
fi

if [ "$STATUS" != "on" ]; then
    echo "Warning: Device '$NAME' status is '$STATUS' (may not be reachable)"
fi

echo "Found: $NAME (MAC: $MAC, IP: $IP, Status: $STATUS)"

# Update SSH config
SSH_CONFIG="$HOME/.ssh/config"
if [ ! -f "$SSH_CONFIG" ]; then
    touch "$SSH_CONFIG"
    chmod 600 "$SSH_CONFIG"
fi

# Function to update SSH config
update_ssh_config() {
    local host_name="$1"
    local ip_addr="$2"
    
    # Check if host already exists in config (only first occurrence)
    if grep -q "^Host $host_name$" "$SSH_CONFIG" 2>/dev/null; then
        # Update existing entry (only the first one)
        echo "Updating SSH config for host '$host_name' with IP $ip_addr"
        
        # Create temp file with updated config
        temp_config=$(mktemp)
        in_host_block=0
        hostname_updated=0
        first_occurrence_done=0
        
        while IFS= read -r line; do
            if [[ "$line" =~ ^Host[[:space:]]+$host_name$ ]] && [[ "$first_occurrence_done" -eq 0 ]]; then
                in_host_block=1
                echo "$line" >> "$temp_config"
            elif [[ "$in_host_block" -eq 1 ]]; then
                if [[ "$line" =~ ^[[:space:]]*HostName[[:space:]] ]]; then
                    echo "    HostName $ip_addr" >> "$temp_config"
                    hostname_updated=1
                elif [[ "$line" =~ ^Host[[:space:]] ]] || ([[ -z "${line// }" ]] && [[ "$hostname_updated" -eq 1 ]]); then
                    if [[ "$hostname_updated" -eq 0 ]]; then
                        echo "    HostName $ip_addr" >> "$temp_config"
                    fi
                    in_host_block=0
                    first_occurrence_done=1
                    echo "$line" >> "$temp_config"
                else
                    echo "$line" >> "$temp_config"
                fi
            else
                echo "$line" >> "$temp_config"
            fi
        done < "$SSH_CONFIG"
        
        # Handle case where host block is at end of file
        if [[ "$in_host_block" -eq 1 ]] && [[ "$hostname_updated" -eq 0 ]]; then
            echo "    HostName $ip_addr" >> "$temp_config"
        fi
        
        mv "$temp_config" "$SSH_CONFIG"
    else
        # Add new entry
        echo "Adding SSH config for host '$host_name' with IP $ip_addr"
        {
            echo ""
            echo "Host $host_name"
            echo "    HostName $ip_addr"
            echo "    User $USER"
        } >> "$SSH_CONFIG"
    fi
}

# Update SSH config with the device info
update_ssh_config "$NAME" "$IP"

echo "Connecting to $NAME..."
echo

# SSH into the device using hostname from config
ssh "$NAME" "$@"
